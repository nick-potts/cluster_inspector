#!/bin/sh

# Railway clustering setup
# Requires: RAILWAY_PRIVATE_DOMAIN set by Railway

if [ -n "$RAILWAY_PRIVATE_DOMAIN" ]; then
  # Use long names for distributed Erlang with IPv6 in brackets
  export RELEASE_DISTRIBUTION=name

  # Shared cookie for cluster - set RELEASE_COOKIE env var in Railway
  export RELEASE_COOKIE="${RELEASE_COOKIE:-cluster_monitor_cookie}"

  # Enable IPv6 for Erlang distribution
  # Use a fixed port range for distribution (avoid EPMD issues)
  export ERL_FLAGS="-proto_dist inet6_tcp -kernel inet_dist_use_interface {0,0,0,0,0,0,0,0} -erl_epmd_port 4369"
  export ERL_EPMD_ADDRESS="::"

  # Start EPMD if not running
  epmd -daemon -address :: 2>/dev/null || true

  # Get IPv6 address (Railway provides fd12:... addresses)
  IPV6=$(hostname -i | grep -oE 'fd[0-9a-f:]+' | head -1)

  if [ -n "$IPV6" ]; then
    # IPv6 addresses must be wrapped in brackets for Erlang longnames
    export RELEASE_NODE="cluster_monitor@[${IPV6}]"
  else
    # Fallback to hostname if no IPv6
    export RELEASE_NODE="cluster_monitor@$(hostname -f)"
  fi
fi
